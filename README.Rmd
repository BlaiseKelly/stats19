---
output: github_document
bibliography: vignettes/references.bib
---

[![The API of a maturing package has been roughed out, but finer details likely to change.](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)
[![Travis build status](https://travis-ci.org/ITSLeeds/stats19.svg?branch=master)](https://travis-ci.org/ITSLeeds/stats19)
[![codecov](https://codecov.io/gh/ITSLeeds/stats19/branch/master/graph/badge.svg)](https://codecov.io/gh/ITSLeeds/stats19)
[![Gitter chat](https://badges.gitter.im/ITSLeeds/stats19.png)](https://gitter.im/stats19/Lobby?source=orgpage)
[![](http://www.r-pkg.org/badges/version/stats19)](http://www.r-pkg.org/pkg/stats19)
[![CRAN RStudio mirror downloads](http://cranlogs.r-pkg.org/badges/stats19)](http://www.r-pkg.org/pkg/stats19)

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# stats19

**stats19** provides functions for downloading and formatting road crash data.
Specifically, it enables access to the UK's official road traffic casualty database, [STATS19](https://data.gov.uk/dataset/cb7ae6f0-4be6-4935-9277-47e5ce24a11f/road-safety-data) (the name comes from the form used by the police to record car crashes and other incidents resulting in casualties on the roads).

The data, in its original form, is provided as a series of .csv files that are stored in dozens of `.zip` files.
Finding, reading-in and formatting the data for research can be a time consuming process subject to human error.
**stats19** speeds-up these vital data access and cleaning stages of the research process, enabling reproducibility, by streamlining the work into 3 stages:

- **Download**: This stage is taken care of by the `dl_stats19()` function. `year`, `type` and `filename` arguments make it easy to find the right file for your research question.

- **Read**: STATS19 data is provided in a particular format that benefits from being read-in with pre-specified column types. This is taken care of with `read_*()` functions corresponding to the 3 main tables in STATS19 data:

  - `read_accidents()` reads-in the crash data (which has one row per incident)
  - `read_casualties()` reads-in the casualty data (which has one row per person injured or killed)
  - `read_vehicles()` reads-in the vehicles table, which contains information on the vehicles involved in the crashes (one row per vehicle)
  
- **Format**: in this stage labels are added to the tables. The raw data provided by the DfT contains only integers. Running the following commands converts these integer values to the corresponding character variables, for each of the three tables:

  - `read_accidents()` adds labels to the accidents table. The values in the `accident_severity` column, for example, are converted from `1`, `2` and `3` into `Slight`, `Serious` or `Fatal`.
  - `read_casualties()` formats the casualty data
  - `read_vehicles()`formats the vehicle data

By default, stages 2 and 3 are done automatically in the `read_*()` functions.
To read-in the raw data, without formatting, set `format = FALSE`.

A full description of the stats19 data and variables they contain can be found in a [document](http://data.dft.gov.uk/road-accidents-safety-data/Brief-guide-to%20road-accidents-and-safety-data.doc) hosted by the UK's Department for Transport (DfT).

## Installation

Install and attach the latest version with:

```{r install, eval=FALSE}
devtools::install_github("ITSLeeds/stats19")
```

```{r attach}
library(stats19)
```

<!-- You can install the released version of stats19 from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("stats19") -->
<!-- ``` -->

## Data download

**stats19** enables download of raw stats19 data with `dl_*` functions.
The following code chunk, for example, downloads and unzips a .zip file containing Stats19 data from 2017:

```{r example}
dl_stats19(year = 2017, type = "Accidents")
```

Currently, these files are downloaded to a default location of "tempdir" which is a platform independent "safe" location to download the data in. Once downloaded, they are unzipped under original DfT file names. The function prints out the location and final file name(s) of unzipped files(s) as shown above.

Data files from other years can be downloaded in an interactive manner, providing just the year for example, would result in options presented to you:

```{r, eval=FALSE}
dl_stats19(year = 2017)
```

```
Multiple matches. Which do you want to download?

1: dftRoadSafetyData_Vehicles_2017.zip
2: dftRoadSafetyData_Casualties_2017.zip
3: dftRoadSafetyData_Accidents_2017.zip

Selection: 
Enter an item from the menu, or 0 to exit
```

## Reading-in and formatting STATS19 data

As mentioned above STATS19 contains 3 main tables:

- Accidents, the main table which contains information on the crash time, location and other variables (`r ncol(accidents_sample)` columns in total)
- Casualties, with data on the people hurt or killed in each crash (`r ncol(casualties_sample)` columns in total)
- Vehicles, with data on the vehicles involved in or causing each crash (`r ncol(vehicles_sample)` columns in total)

Code to read-in and format each of these tables is demonstrated below.

### Crash data

After raw data files have been downloaded (as described in the previous section), they can then be read-in as follows:

```{r}
crashes_2017_raw = read_accidents(year = 2017, format = FALSE)
crashes_2017 = format_accidents(crashes_2017_raw)
nrow(crashes_2017_raw)
ncol(crashes_2017_raw)
```

What just happened?
We read-in data on all road crashes recorded by the police in 2017 across Great Britain.
The dataset contains `r ncol(crashes_2017_raw)` columns (variables) for `r nrow(crashes_2017_raw)` crashes.

This work was done by `read_accidents()`, which imported the 'raw' Stats19 data without cleaning messy column names or re-categorising the outputs (by default `format = TRUE`, meaning the datasets are formated when read-in).
`format_accidents()` does the formatting work, automating the process of matching column names with variable names and labels in a [`.xls` file](http://data.dft.gov.uk/road-accidents-safety-data/Road-Accident-Safety-Data-Guide.xls) provided by the DfT.
This means `crashes_2017` is much more usable than `crashes_2017_raw`, as shown below, which shows some key variables in the messy and clean datasets:

```{r}
crashes_2017_raw[c(7, 18, 23, 25)]
crashes_2017[c(7, 18, 23, 25)]
```

For the full list of columns, run `names(crashes)` or see the vignette.

<!-- This means `crashes_2017` is much more usable than `crashes_2017_raw`, as shown below, which shows three records and some key variables in the messy and clean datasets: -->

```{r, echo=FALSE, eval=FALSE}
# commented out as confusing...
key_patt = "severity|speed|light|human"
key_vars = grep(key_patt, x = names(crashes_2017_raw), ignore.case = TRUE)
random_n = sample(x = nrow(crashes_2017_raw), size = 3)
crashes_2017_raw[random_n, key_vars]
crashes_2017[random_n, key_vars]
```

**Note**: The Department for Transport calls this table 'accidents' but a more appropriate term may be more appropriate, according to road safety advocacy groups such as [RoadPeace](http://www.roadpeace.org/take-action/crash-not-accident/).
For this reason we are faithful to the name provided in the data's official documentation but call the resulting datset `crashes`.

## Casualties data

As with `crashes_2017`, casualty data for 2017 can be downloaded, read-in and formated as follows:

```{r}
dl_stats19(year = 2017, type = "casualties")
casualties_2017 = read_casualties(year = 2017)
nrow(casualties_2017)
ncol(casualties_2017)
```

The results show that there were `r nrow(casualties_2017)` casualties reported by the police in the STATS19 dataset in 2017.
There are `r ncol(casualties_2017)` columns (variables) on these casualties.
Values for a sample of these columns is shown below:

```{r}
casualties_2017[c(4, 5, 6, 14)]
```

The full list of column names in the `casualties` dataset is:

```{r}
names(casualties_2017)
```

## Vehicles data

As before, vehicles data for 2017 can be downloaded, read-in and formated as follows:

```{r}
dl_stats19(year = 2017, type = "vehicles")
vehicles_2017 = read_vehicles(year = 2017)
nrow(vehicles_2017)
ncol(vehicles_2017)
```

The results show that there were `r nrow(vehicles_2017)` vehicles involved in crashes reported by the police in the STATS19 dataset in 2017.
There are `r ncol(vehicles_2017)` columns (variables) on these vehicles.
Values for a sample of these columns is shown below:

```{r}
vehicles_2017[c(3, 14:16)]
```

The full list of column names in the `vehicles` dataset is:

```{r}
names(vehicles_2017)
```

<!-- More data can be read-in as follows: -->

```{r, eval=FALSE, echo=FALSE}
# old code to be up-dated
d14 = "Stats19_Data_2005-2014"
crashes_2005_2014 = read_accidents(data_dir = d14)
crashes_2005_2014_f = format_stats19_2005_2014_ac(crashes_2005_2014)
d15 = "RoadSafetyData_2015"
crashes_2015 = read_accidents(data_dir = d15, filename = "Accidents_2015.csv")
crashes_2015_f = format_stats19_2015_ac(crashes_2015)
d16 = "dftRoadSafety_Accidents_2016"
crashes_2016 = read_accidents(data_dir = d16, filename = "dftRoadSafety_Accidents_2016.csv")
crashes_2016_f = format_stats19_2016_ac(crashes_2016)
all_crashes = rbind(crashes_2015_f, crashes_2016_f, crashes_2017_f)
table(ac$Accident_Severity)
```

## Creating geographic crash data

An important feature of STATS19 data is that the 'accidents' table contains geographic coordinates.
These are provided at ~10m resolution in the UK's official coordinate reference system (the Ordnance Survey National Grid, EPSG code 27700).
**stats19** converts the non-geographic tables created by `format_accidents()` into a geographic (`sf`) data form with the function `format_sf()` as follows:

```{r}
crashes_sf = format_sf(crashes_2017)
```

Note: rows without coordinates are removed, NAs are not permitted in `sf` coordinates.
Once the data is in this form you can do geographic operations on it.
The following code chunk, for example, returns all crashes in the Leeds local authority (requires the **ukboundaries** GitHub package):

```{r}
library(sf)
leeds_osgb = st_transform(ukboundaries::leeds, crs = 27700)
crashes_leeds = crashes_sf[leeds_osgb, ]
```


## Joining tables

The three tables we have just read-in can be joined by shared key variables.
This is demonstrated in the code chunk below, which subsets all casualties that took place in Leeds, and counts the number of casualties by severity for each crash:

```{r}
sel = casualties_2017$accident_index %in% crashes_leeds$accident_index
casualties_leeds = casualties_2017[sel, ]
library(tidyverse)
cas_types = casualties_leeds %>% 
  select(accident_index, casualty_type) %>% 
  mutate(n = 1) %>% 
  group_by(accident_index, casualty_type) %>% 
  summarise(n = sum(n)) %>% 
  spread(casualty_type, n, fill = 0) 
cas_types$Total = rowSums(cas_types[-1])
crashes_joined = left_join(crashes_leeds, cas_types)
```

What just happened? We found the subset of casualties that took place in Leeds with reference to the `accident_index` variable.
Then we used functions from the **tidyverse** package **dplyr** (and `spread()` from **tidyr**) to create a dataset with a column for each casualty type.
We then joined the updated casualty data onto the `crashes_leeds` dataset.
The result is a spatial (`sf`) data frame of crashes in Leeds, with columns counting how many road users of different types were hurt.
We can now explore the spatial distribution of different casualty types as follows:

```{r sfplot, fig.show='hold', out.width="33%"}
plot(crashes_joined[crashes_joined$Pedestrian > 0, "Pedestrian"])
plot(crashes_joined[crashes_joined$Cyclist > 0, "Cyclist"])
plot(crashes_joined[crashes_joined$`Car occupant` > 0, "Car occupant"])
```

It is clear from the previous plot that pedestrians, cyclists and car occupants tend to get hurt in different places.
Car occupant casulaties, for example, are comparatively common on the outskirts of Leeds, where speed limits tend to be higher and where there are comparatively high volumes of motor traffic, compared with the city centre.

Another way of visualising the data, in this case to show the spatial distribution of crashes causing pedestrian casualties by number of pedestrians hurt and crash severity, is with **ggplot2**:

```{r ggplot}
ggplot(crashes_joined, aes(colour = Total)) +
  geom_sf() +
  facet_grid(vars(accident_severity), vars(Pedestrian))
```

Note: Both figures show that pedestrian casualties tend to happen more frequently near the city centre, compared with other types of casualty.

## Time series analysis

We can explore weekly and seasonal trends in crashes by aggregating crashes by day of the year:

```{r dates}
crashes_dates = crashes_joined %>% 
  st_set_geometry(NULL) %>% 
  group_by(date = lubridate::dmy(date)) %>% 
  summarise(Pedestrian = sum(Pedestrian), Cyclist = sum(Cyclist),
            `Car occupant` = sum(`Car occupant`)) %>% 
  gather(mode, casualties, -date)
ggplot(crashes_dates, aes(date, casualties)) +
  geom_smooth(aes(colour = mode)) +
  ylab("Casualties per day")
```


Different types of crashes also tend to happen at different times of day.
This is illustrated in the plot below, which shows the times of day when people who were travelling by different modes were most commonly injured.

```{r times}
crash_times = crashes_joined %>% 
  st_set_geometry(NULL) %>% 
  group_by(hour = as.numeric(str_sub(time, 1, 2))) %>% 
  summarise(Pedestrian = sum(Pedestrian), Cyclist = sum(Cyclist),
            `Car occupant` = sum(`Car occupant`)) %>% 
  gather(mode, casualties, -hour)
ggplot(crash_times, aes(hour, casualties)) +
  geom_line(aes(colour = mode))
  
```

Note the morning peak in cycling [see @lovelace_who_2016 form more on this].

## Next steps

There is much important research that needs to be done to help make the transport systems in many cities safer.
Even if you're not working with UK data, we hope that the data provided by **stats19** data can help safety researchers develop new methods to better understand the reasons why people are needlessly hurt and killed on the roads.

The next step is to gain a deeper understanding of **stats19** and the data it provides.
Then it's time to pose interesting research questions, some of which could provide an evidence-base in support policies that save lives [e.g. @sarkar_street_2018].
For more on these next steps, see the package's introductory vignette.

## Further information

The **stats19** package builds on previous work, including:

- code in the [bikeR](https://github.com/Robinlovelace/bikeR) repo underlying an academic paper on collisions involving cyclists
- functions in [**stplanr**](https://github.com/ropensci/stplanr/blob/master/R/load-stats19.R) for downloading Stats19 data
- updated functions related to the [CyIPT](https://github.com/cyipt/stats19) project

## References

