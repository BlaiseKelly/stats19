---
title: "Reproducing _Reported road casualties in Great Britain: pedestrian factsheet, 2023"
author: "Blaise Kelly"
format: html
editor: source
self-contained: true
---
# Introduction
This document aims to reproduce the 2018-2022 sections of the ["Accredited official statistics Reported road casualties in Great Britain: pedestrian factsheet, 2022"](https://www.gov.uk/government/statistics/reported-road-casualties-great-britain-pedestrian-factsheet-2022/reported-road-casualties-in-great-britain-pedestrian-factsheet-2022#further-information) report published on 28th September 2023.

```{r setup, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}

# https://www.gov.uk/government/statistics/reported-road-casualties-great-britain-pedestrian-factsheet-2023/reported-road-casualties-in-great-britain-pedestrian-factsheet-2023

library(stats19)
library(sf)
library(dplyr)
library(lubridate)
library(reshape2)
library(ggplot2)
library(knitr)
library(readODS)

# what casualty is the report for? options Pedestrian, Cyclist, escooters
report_casualty <- "Pedestrian"

  # stats19 usually updated in September, so if it is October last years data should be there
  yr2calc <- 2023

  # request collision data (entering 2004 results in a table with all years)
  crashes = get_stats19(year = "2004", type = "collision", ask = FALSE, format = TRUE, output_format = "data.frame")

  ## request casualty
  casualties = get_stats19(year = "2004", type = "casualty", ask = FALSE, format = TRUE, output_format = "data.frame")

  ## request vehicle
  vehicles = get_stats19(year = "2004", type = "vehicle", ask = FALSE, format = TRUE, output_format = "data.frame")

  # report only considers data from 2004 onwards
  crashes <- filter(crashes, accident_year >= 2004)
  casualties <- filter(casualties, accident_year >= 2004)
  vehicles <- filter(vehicles, accident_year >= 2004)
  #
  #

# get population data from https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates
  uk_pop <- read.csv("https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatestimeseriesdataset/current/pop.csv", skip = 7)
  uk_pop <- uk_pop[,c(1,6)]
  names(uk_pop) <- c("Year", "Population")


  # get trip data NTS0303 https://www.gov.uk/government/statistical-data-sets/nts03-modal-comparisons
  download.file("https://assets.publishing.service.gov.uk/media/66ce0f118e33f28aae7e1f75/nts0303.ods", destfile = "nts0303.ods", mode = "wb")
  #download.file("https://assets.publishing.service.gov.uk/media/66ce0e818e33f28aae7e1f71/nts0101.ods", destfile = "nts0101.ods", mode = "wb")

  trips <- read_ods("nts0303.ods", sheet = "NTS0303c_miles", skip = 5) |>
    left_join(uk_pop, by = "Year") |>
    mutate(tot_dist_billion_miles = (`Walk [notes 2, 3]`*Population)/10^9)

    # ## save having to import each time or to work offline
  #save(crashes, casualties, vehicles,trips,uk_pop, file = "all_years.RData")

#load("all_years.RData")

    # # most of the data is based on the last 5 years, speed up calcs by creating df for this
crashes$number_of_casualties <- as.numeric(crashes$number_of_casualties)
  cra_L5Y <- filter(crashes, accident_year <= yr2calc & accident_year >= yr2calc-4)
  cas_L5Y <- filter(casualties, accident_year <= yr2calc & accident_year >= yr2calc-4)
  veh_L5Y <- filter(vehicles, accident_year <= yr2calc & accident_year >= yr2calc-4)
#   
# 

```


```{r, echo = FALSE, warning=FALSE, message=FALSE}

# pick out data only for 2004
fat_cas_2004 <- casualties |> filter(accident_year == "2004" & casualty_severity == "Fatal" & casualty_class == report_casualty)
#casualties this year (TY)
fat_cas_TY <- casualties |> filter(accident_year == yr2calc & casualty_severity == "Fatal" & casualty_class == report_casualty)

if(NROW(fat_cas_2004)>NROW(fat_cas_TY)){
  ud <- "down"
  fat_cas_diff <- round((1-NROW(fat_cas_TY)/NROW(fat_cas_2004))*100)
} else {
  ud <- "up"
  fat_cas_diff <- round((1-NROW(fat_cas_2004)/NROW(fat_cas_TY))*100)
}

ser_cas_2004 <- casualties |> filter(accident_year == "2004" & casualty_severity == "Serious" & casualty_class == report_casualty)
#casualties this year (TY)
ser_cas_TY <- casualties |> filter(accident_year == yr2calc & casualty_severity == "Serious" & casualty_class == report_casualty)

if(NROW(ser_cas_2004)>NROW(ser_cas_TY)){
  id <- "decreased"
  ser_cas_diff <-((NROW(ser_cas_TY)/NROW(ser_cas_2004))*100)
} else {
  id <- "increased"
  ser_cas_diff <- round((1-NROW(ser_cas_2004)/NROW(ser_cas_TY))*100)
}

dist_walked_2004 <- filter(trips, Year == "2004")
dist_walked_TY <- filter(trips, Year == yr2calc)

ped_traf <- (dist_walked_TY$tot_dist_billion_miles/dist_walked_2004$tot_dist_billion_miles)-1

```
# 1. Main findings
Between 2004 and 2023:

 - fatalities were `r ud` `r fat_cas_diff`% from `r NROW(fat_cas_2004)` to `r NROW(fat_cas_TY)`  
 - serious injuries decreased by `r round(ser_cas_diff)`%  
 - pedestrian traffic (distance walked) increased by `r round(ped_traf*100)`%

Averaged over the period `r yr2calc-4` to `r yr2calc`:

```{r, echo = FALSE, warning=FALSE, message=FALSE}

crash_cas <- inner_join(cas_L5Y,cra_L5Y) |> 
  filter(casualty_type == report_casualty)
  
# create column for weeks
dths_per_wk <- crash_cas %>%
  mutate(wk = isoweek(date),## calculate the day of week, Monday is 1
         yr = year(date)) %>% ## add year so all weeks over the 5 years are included
  select(wk,yr, accident_severity, casualty_class, accident_reference) %>% ## pick out the columns needed
  mutate(number_of_casualties = 1) |> # each row is a casualty
  filter(casualty_class == report_casualty) |>  ## pick out casualty the stats will focus on
  group_by(wk,yr, accident_severity) %>%
  summarise(casualties = sum(number_of_casualties))

  ## filter for only fatal collisions
fatal_wk <- dths_per_wk %>% 
  filter(accident_severity == "Fatal")

## filter for only serious injuries
serious_wk <- dths_per_wk %>% 
  filter(accident_severity == "Serious")

```

 - an average of `r round(mean(fatal_wk$casualties))` pedestrians died and `r round(mean(serious_wk$casualties))` were seriously injured  per week in reported road collisions
 
```{r, echo = FALSE, warning=FALSE, message=FALSE}

## 20m junction
junctions <- crash_cas %>% 
  select(accident_severity, casualty_type, junction_detail, accident_reference) %>% 
  filter(casualty_type == report_casualty) %>% 
  mutate(count = 1) |> 
  group_by(accident_severity, junction_detail) %>% 
  summarise(casualties = sum(count)) 

## stats for within 20m of junctions
fatal_within_20 <- junctions %>% 
  filter(accident_severity == "Fatal") %>% 
  mutate(pc_junction = casualties/sum(casualties)*100) %>% 
  filter(junction_detail == "Not at junction or within 20 metres")

serious_within_20 <- junctions %>% 
  filter(accident_severity == "Serious") %>% 
  mutate(pc_junction = casualties/sum(casualties)*100)%>% 
  filter(junction_detail == "Not at junction or within 20 metres")

```

 - a majority of pedestrian fatalities (`r round(fatal_within_20$pc_junction)`%) do not occur at or within 20m of a junction compared to `r round(serious_within_20$pc_junction)`% of all seriously injured casualties

```{r, echo = FALSE, warning=FALSE, message=FALSE}

## single cars
number_vehicles <- crash_cas |> 
  select(accident_severity, casualty_type, number_of_vehicles,accident_reference) |> 
  filter(casualty_type == report_casualty) |> 
  mutate(count = 1) |> 
  group_by(accident_severity, number_of_vehicles) |> 
  summarise(casualties = sum(count)) 

# make table of only fatal to determine percentage of single
fatal_number_vehicle <- number_vehicles %>% 
  filter(accident_severity == "Fatal") |> 
  mutate(pc_vehicles = (casualties/sum(casualties))*100)


```

 - `r round(fatal_number_vehicle$pc_vehicles[1])`% of pedestrian fatalities were in collisions involving a single car


```{r, echo = FALSE, warning=FALSE, message=FALSE}

## rural or urban
rural_urban <- crash_cas %>% 
  select(accident_severity, casualty_type, urban_or_rural_area, accident_reference) %>% 
  filter(casualty_type == "Pedestrian") %>% 
   mutate(count = 1) %>% 
  group_by(accident_severity, urban_or_rural_area) %>% 
  summarise(casualties = sum(count)) 

fatal_rural <- rural_urban %>% 
  filter(accident_severity == "Fatal") %>% 
  mutate(pc_rural = casualties/sum(casualties)*100)

serious_rural <- rural_urban %>% 
  filter(accident_severity == "Serious") %>% 
  mutate(pc_rural = casualties/sum(casualties)*100)

rural_urban_all_cas <- crash_cas %>% 
  select(accident_severity, casualty_type, urban_or_rural_area, number_of_casualties,accident_reference) %>% 
  filter(casualty_type == "Pedestrian") %>% 
  mutate(count = 1) %>% 
  group_by(urban_or_rural_area) %>% 
  summarise(casualties = sum(count)) %>% 
  mutate(pc_rural = casualties/sum(casualties)*100) |> 
  filter(urban_or_rural_area == "Rural")

```

 - `r round(fatal_rural$pc_rural[1])`% of pedestrian fatalities occurred on rural roads compared to `r round(rural_urban_all_cas$pc_rural)`% of all pedestrian casualties

```{r, echo = FALSE, warning=FALSE, message=FALSE}

## male female
sex_casualty <- crash_cas %>% 
  select(accident_severity, casualty_type, sex_of_casualty, number_of_casualties,accident_reference) %>% 
  filter(casualty_type == "Pedestrian") %>% 
   mutate(count = 1) %>% 
  group_by(accident_severity, sex_of_casualty) %>% 
  summarise(casualties = sum(count)) 

serious_fatal_male <- sex_casualty %>% 
  filter(sex_of_casualty == "Male" & accident_severity %in% c("Fatal", "Serious"))

fatal_serious_tot <-sex_casualty %>% 
  filter(accident_severity %in% c("Fatal", "Serious"))

pc_fatal_serious_male <- sum(serious_fatal_male$casualties)/sum(fatal_serious_tot$casualties)*100

```

 - `r round(pc_fatal_serious_male)`% of pedestrian killed or seriously injured (KSI) casualties were male

The most common contributory factor allocated to pedestrians *no contributory factors included in this data?*

# 2. Pedestrian traffic and reported casualties
```{r, echo = FALSE, warning=FALSE, message=FALSE}

## only latest year (TY) in report
fatal_TY <- filter(casualties, accident_year == yr2calc, casualty_type == report_casualty, casualty_severity == "Fatal")

serious_TY <- filter(casualties, accident_year == yr2calc, casualty_type == report_casualty, casualty_severity == "Serious")

slight_TY <- filter(casualties, accident_year == yr2calc, casualty_type == report_casualty, casualty_severity == "Slight")

```

In `r yr2calc`, `r NROW(fatal_TY)` pedestrians were killed in Great Britain, whilst `r NROW(serious_TY)` were reported to be seriously injured and `r NROW(slight_TY)` slightly injured.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

trips <- select(trips, Year, Traffic = tot_dist_billion_miles)

table_1 <- casualties |> 
  filter(casualty_type == report_casualty) |> 
  mutate(casualty = 1) |> 
  group_by(accident_year, casualty_severity) |> 
  summarise(casualties = sum(casualty)) |> 
  tidyr::pivot_wider(names_from = "casualty_severity", values_from = "casualties") |> 
  rowwise() %>% 
  mutate(All = sum(c(Fatal, Serious, Slight))) |> 
  left_join(trips, by = c("accident_year" = "Year"))

dist_walked_2004 <- filter(trips, Year == 2004)
dist_walked_TY <- filter(trips, Year == yr2calc)

if(dist_walked_2004$Traffic > dist_walked_TY$Traffic){
  dw <- "decreased"
} else {
  dw <- "increased"
}

```

Table 1 and Chart 1 show that pedestrian traffic (measured by distance walked) has `r dw` between 2004 and `r yr2calc` whilst fatalities, serious and slight injuries have fallen.

```{r, echo = FALSE, warning=FALSE, message=FALSE}
## change between this year (TY) and last year (LY)
diff_fatal <- (table_1$Fatal[20]-table_1$Fatal[19])/table_1$Fatal[19]

diff_trips <- abs(table_1$Traffic[20]-table_1$Traffic[19])/table_1$Traffic[19]

# pedestrian fatalities increased or decreased
if(table_1$Fatal[20]>table_1$Fatal[19]){
  pf <- "increased"
} else {
  pf <- "decreased"
}

# pedestrian casualties all severities increased or decreased
if(table_1$All[20]>table_1$All[19]){
  pcr <- "increased"
} else {
  pcr <- "fallen"
}

```

Between `r yr2calc-1` and `r yr2calc`, pedestrian fatalities `r pf` by `r round(diff_fatal*100)`% while pedestrian traffic (distance walked) `r dw` by `r round(diff_trips*100)`%.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

calc_index <- function(x) sum(x != 0) / length(x) * 100

benchmark_values <- table_1 %>% filter(accident_year == 2004) %>% select(where(is.numeric))

chart_1 <- table_1 %>%
  mutate(across(where(is.numeric), ~ .x / benchmark_values[[cur_column()]] * 100)) |> 
  select(-All) |> 
  melt("accident_year")

cols <- rev(c("#001a70", "#ff7733", "#1de9b6","#006853"))
cust_theme <- theme(panel.grid.major = element_line(size = 2))
# put the elements in a list
dft_theme <- list(cust_theme, scale_color_manual(values = cols))

chart_1 %>% 
  ggplot(aes(accident_year, value, color = variable)) +
  geom_line(size = 2, alpha = .8) +
  dft_theme+
  theme(panel.background = element_blank(),
        legend.position = "top",
    legend.title = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) +
  geom_hline(yintercept=100, linetype='dotted', col = 'black')+
  ggtitle("Chart 1: Index of casualties by severity, GB: 2004 to 2023 (Index 2004=100)") +
  scale_x_continuous(name = NULL,
    breaks = seq(2004, 2023, by = 2)  # Add more tick marks
  ) +
  labs(caption = "Source: Stats19")

kable(table_1, caption = "Table 1: Number of reported pedestrian casualties by severity and traffic (pedestrian billion miles walked), GB: 2004 to 2023")



```

# 3. How far do pedestrians travel?
The National Travel Survey (NTS) which provides the [number of trips and average distance travelled](https://www.gov.uk/government/statistical-data-sets/nts03-modal-comparisons) (NTS0303) by person per year for English residents. This is used to derive casualty rates per mile travelled for pedestrians, which also use the Great Britain population figure to estimate total distance walked each year.

# 4. Casualty rates per mile
The pedestrian casualty rate has `r pcr` for all severities in `r yr2calc` compared to 2004.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

# compare the last year to 2004 for all stats
diff_all_2004 <- abs(table_1$All[20]-table_1$All[1])/table_1$All[1]
diff_fat_2004 <- abs(table_1$Fatal[20]-table_1$Fatal[1])/table_1$Fatal[1]
diff_sev_2004 <- abs(table_1$Serious[20]-table_1$Serious[1])/table_1$Serious[1]
diff_sli_2004 <- abs(table_1$Slight[20]-table_1$Slight[1])/table_1$Slight[1]

```

The overall casualty rate decreased by `r round(diff_all_2004*100)`%. The fatality rate decreased by `r round(diff_fat_2004)`% compared to a `r round(diff_sev_2004,2)`% reduction for serious injuries and a `r round(diff_sli_2004,2)`% reduction for slight injuries.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

# pick out traffic
chart_2 <- filter(chart_1, !variable == "Traffic")

# define the colour palette
cols <- rev(c("#ff7733", "#1de9b6","#006853"))
cust_theme <- theme(panel.grid.major = element_line(size = 2))
# put the elements in a list
dft_theme <- list(cust_theme, scale_color_manual(values = cols))



chart_2 %>% 
  ggplot(aes(accident_year, value, color = variable)) +
  geom_line(size = 2, alpha = .8) +
  dft_theme+
  theme(panel.background = element_blank(),
        legend.position = "top",
    legend.title = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) +
  geom_hline(yintercept=100, linetype='dotted', col = 'black')+
  ggtitle("Chart 1: Index of casualties by severity, GB: 2004 to 2023 (Index 2004=100)") +
  scale_x_continuous(name = NULL,
    breaks = seq(2004, 2023, by = 2)  # Add more tick marks
  ) +
  labs(caption = "Source: Stats19")

table_2 <- table_1 |> 
  transmute(Fatal = round(Fatal/Traffic),
         Serious = round(Serious/Traffic),
         Slight = round(Slight/Traffic),
         All = round(All/Traffic))



kable(table_2, caption = paste0("Table 2: Casualty rates of pedestrian casualties by severity per billion miles walked, GB: 2004 to ",yr2calc))
  
```


# 5. Sex and age comparisons

```{r, echo = FALSE, warning=FALSE, message=FALSE}

## by sex and age
sex_age_casualty <- cas_L5Y %>% 
  select(casualty_severity, casualty_type, sex_of_casualty, age_of_casualty) %>% 
  filter(casualty_type == report_casualty) %>% 
  mutate(count = 1) %>% 
  group_by(casualty_severity, sex_of_casualty, age_of_casualty) %>% 
  summarise(casualties = sum(count))

male_cas <- cas_L5Y |> filter(casualty_type == report_casualty & sex_of_casualty == "Male") 
female_cas <- cas_L5Y |> filter(casualty_type == report_casualty & sex_of_casualty == "Female") 

## sex and age again
tot_sexes <- sex_age_casualty %>% 
  ungroup() %>% 
  group_by(sex_of_casualty) %>% 
  summarise(casualties = sum(casualties))

male_tot <- round(tot_sexes$casualties[3]/sum(tot_sexes$casualties)*100)
female_tot <- round(tot_sexes$casualties[2]/sum(tot_sexes$casualties)*100)

males_times <- tot_sexes$casualties[3]/tot_sexes$casualties[2]


## by sex and age
sac_all <- casualties %>% 
  select(accident_year, casualty_severity, casualty_type, sex_of_casualty, age_of_casualty) |> 
  filter(accident_year >= yr2calc) |> 
  filter(casualty_type == report_casualty) |> 
  filter(sex_of_casualty %in% c("Male", "Female")) |> 
  filter(!casualty_severity == "Slight") |> 
  mutate(count = 1) |> 
  mutate(age_band = cut(as.numeric(age_of_casualty), breaks=c(0,11,15,19,24,29,39,49,59,69,100),labels=c("0-11","12-15","16-19","20-24","25-29","30-39","40-49","50-59","60-69","70+"))) |> 
  group_by(sex_of_casualty, age_band) %>% 
  summarise(casualties = sum(count)) |> 
    filter(!is.na(age_band))

# age band 1
ab1 <- "30-39"

# male female casualties for this age band
sac_ab1 <- sac_all |>  filter(age_band == ab1)

ab2 <- "0-11"

# male female casualties for this age band
sac_ab2 <- sac_all |>  filter(age_band == ab2)

ab3 <- "70+"

# male female casualties for this age band
sac_ab3 <- sac_all |>  filter(age_band == ab3)

cas_tot <- sum(sac_all$casualties)

sac_all$pc_ksi <- (sac_all$casualties/cas_tot)*100 

```
Between `r yr2calc-4` and `r yr2calc`, `r round(male_tot)`% of pedestrian casualties were male and `r round(female_tot)`% female.

There are `r round(males_times, 1)` times more male than female pedestrian casualties overall. This compares to `r round(sac_ab1$casualties[2]/sac_ab1$casualties[1],1)` more for `r ab1`,  `r round(sac_ab2$casualties[2]/sac_ab2$casualties[1],1)` more for `r ab2`and `r round(sac_ab3$casualties[2]/sac_ab3$casualties[1],1)` more for `r ab3` - the only age group in which female casualties outnumber males.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

# Define colours and theme
cols <- rev(c("#1de9b6", "#006853"))
cust_theme <- theme(panel.grid.major = element_line(size = 2))
dft_theme <- list(cust_theme, scale_fill_manual(values = cols))  # use fill, not color

ggplot(sac_all, aes(x = age_band, y = pc_ksi, fill = sex_of_casualty)) + 
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.7) +
  geom_text(
    aes(label = paste0(round(pc_ksi),"%")),  # Round values to 1 decimal place
    position = position_dodge(width = 0.7),
    vjust = -0.5,
    size = 3
  ) +
  dft_theme +
  theme(
    panel.background = element_blank(),
    legend.position = "top",
    legend.title = element_blank()
  ) +
  ylab(NULL)+
  xlab(NULL)+
  labs(caption = "Source: Stats19")


```

# 6. Which vehicles are involved in collisions with pedestrians?
```{r, echo = FALSE, warning=FALSE, message=FALSE}

## UP TO HERE - think about which datasets are best combined - I think crashes just has a row per collision which reduces duplication of rows when joining

## join vehicle data by accident reference
crash_cas_veh <- cas_L5Y %>%
  #filter(accident_year >= yr2calc) |>
  select(accident_reference, casualty_severity, casualty_type) |>
  inner_join(veh_L5Y) |>
  inner_join(cra_L5Y)

#cas_veh <- inner_join(cas_L5Y, veh_L5Y)

## create some approximate groups
vehicle_groups <- data.frame(vehicle_group = c("pedal_cycle", "motorcycle", "motorcycle", "motorcycle", "motorcycle", "motorcycle",
                                               "motorcycle", "car", "agricultural", "tram", "bus", "bus", "van", "HGV", "HGV", "Other"),
                             stats_19_class =  c("Pedal cycle","Motorcycle - unknown cc", "Electric motorcycle" , "Motorcycle 125cc and under",
                                                 "Motorcycle 50cc and under","Motorcycle over 125cc and up to 500cc", "Motorcycle over 500cc",
                                                 "Car", "Agricultural vehicle", "Tram",
                                                 "Bus or coach (17 or more pass seats)", "Minibus (8 - 16 passenger seats)", "Van / Goods 3.5 tonnes mgw or under",
                                                 "Goods over 3.5t. and under 7.5t", "Goods 7.5 tonnes mgw and over", "Other vehicle"))

## loop through to calculate the proportion of fatalities for each
n_vehicles <- unique(crash_cas_veh$number_of_vehicles)
list_df <- list()
for (v in unique(vehicle_groups$vehicle_group)){

  for (n in n_vehicles){

    v_df <- filter(vehicle_groups, vehicle_group == v)

## vehicle type
vehicle_fatalities <- crash_cas_veh %>%
  filter(vehicle_type %in% v_df$stats_19_class & casualty_severity == "Fatal" & number_of_vehicles == n, casualty_type == report_casualty) |>  
  group_by(accident_reference) %>%
  mutate(count =1) |>
  summarise(casualties = mean(count))

df <- data.frame("vehicle" = v,
                 "number_vehicles" = n,
                   "casualties" = sum(vehicle_fatalities$casualties))

list_df[[paste(v,n)]] <- df

  }

}

all_dfs <- do.call(rbind,list_df) %>%
  arrange(desc(casualties))


```
Between `r yr2calc-4` and `r yr2calc`, most pedestrian fatalities occurred in `r all_dfs$number_vehicles[1]` vehicle collisions involving a `r all_dfs$vehicle[1]` (`r all_dfs$caasualties[1]`).

```{r, echo = FALSE, warning=FALSE, message=FALSE}

list_df <- list()
for (v in unique(vehicle_groups$vehicle_group)){

  v_df <- filter(vehicle_groups, vehicle_group == v)

   for (n in n_vehicles){

    ## vehicle type
    vehicle_proportion <- crash_cas_veh %>%
      select(accident_severity, casualty_type, vehicle_type, number_of_vehicles, number_of_casualties,accident_reference) |>
      filter(casualty_type == "Pedestrian" & vehicle_type %in% v_df$stats_19_class & number_of_vehicles == n) |>
      group_by(accident_severity) |>
      summarise(casualties = sum(as.numeric(number_of_casualties)))
    
    #if(sum(vehicle_proportion$casualties) >4){

    df <- data.frame("vehicle" = v,
                     "number_vehicles" = n,
                     "total casualties" = sum(vehicle_proportion$casualties, na.rm = TRUE),
                     "fatal" = vehicle_proportion$casualties[1],
                     "proportion" = vehicle_proportion$casualties[1]/sum(vehicle_proportion$casualties)*100)
    

    list_df[[paste(v,n)]] <- df
    
   # }

   }
  
}


all_v_df <- do.call(rbind,list_df) %>%
  arrange(desc(proportion))


```

However, the highest proportion of casualties from single vehicle collisions involve a HGV (`r round(all_v_df$proportion[1],1)`%). The second highest proportion () occured in collisions when.

```{r, echo = FALSE, warning=FALSE, message=FALSE}

## reproduce vehicle classes shown in table

vehicle_types <- crash_cas_veh %>%
  select(accident_severity, casualty_type, vehicle_type, number_of_vehicles, number_of_casualties,accident_reference) %>%
  filter(casualty_type == "Pedestrian") %>%
  group_by(accident_severity, vehicle_type, number_of_vehicles) %>%
  summarise(casualties = sum(as.numeric(number_of_casualties))) %>%
  dcast(vehicle_type + number_of_vehicles ~ accident_severity)

vehicle_types_1 <- vehicle_types %>%
  filter(vehicle_type %in% c("Pedal cycle","Motorcycle - unknown cc",
                             "Motorcycle 125cc and under","Motorcycle 50cc and under",
                             "Motorcycle over 125cc and up to 500cc", "Motorcycle over 500cc", "Car",
                             "Bus or coach (17 or more pass seats)", "Van / Goods 3.5 tonnes mgw or under",
                             "Goods over 3.5t. and under 7.5t", "Goods 7.5 tonnes mgw and over", "Other vehicle")) %>%
  filter(number_of_vehicles == 1)

vehicle_types_2 <- crash_cas_veh %>%
  select(accident_severity, casualty_type, number_of_vehicles, number_of_casualties,accident_index) %>%
  filter(casualty_type == "Pedestrian") %>%
  distinct(accident_index, .keep_all = TRUE) %>%
  filter(number_of_vehicles == 2) %>%
  group_by(accident_severity, number_of_vehicles) %>%
  summarise(casualties = sum(as.numeric(number_of_casualties))) %>%
  dcast(number_of_vehicles ~ accident_severity) %>%
  mutate(vehicle_type = "ALL")

vehicle_types_3 <- crash_cas_veh %>%
  select(accident_severity, casualty_type, number_of_vehicles, number_of_casualties,accident_index) %>%
  filter(casualty_type == "Pedestrian") %>%
  distinct(accident_index, .keep_all = TRUE) %>%
  filter(number_of_vehicles > 2) %>%
  dcast(number_of_vehicles ~ accident_severity) %>%
  summarise(Fatal = sum(Fatal),
            Serious = sum(Serious),
            Slight = sum(Slight)) %>%
  mutate(vehicle_type = "ALL") %>%
  mutate(number_of_vehicles = "3 or more")

vehicle_types_table <- rbind(vehicle_types_1, vehicle_types_2, vehicle_types_3)  %>%
  rowwise() |>
    mutate(All_casualties = sum(Fatal,Serious, Slight,na.rm = TRUE)) |>
  mutate(pc_fatal = Fatal/All_casualties*100)


kable(vehicle_types_table, caption = paste0("Table 3: Pedestrian casualties in reported road collisions by severity showing other vehicles involved GB:", yr2calc-4," to ",yr2calc))

```



# 7. Time of day of collisions
```{r, echo = FALSE, warning=FALSE, message=FALSE}
## create a table of severity by year
crash_time <- crash_cas %>% 
  select(accident_severity, casualty_type, datetime, number_of_casualties,accident_reference) %>% 
  mutate(accident_hr = hour(datetime),
         dow = lubridate::wday(datetime))  %>% 
  filter(casualty_type == "Pedestrian") %>% 
  filter(accident_severity %in% c("Fatal", "Serious")) |> 
  mutate(dow = case_when(dow > 1 & dow < 7 ~  "Monday to Friday", dow == 7 ~ "Saturday", dow == 1 ~ "Sunday")) |> 
  mutate(count = 1) %>% 
  group_by(accident_hr, dow) %>%  
  summarise(casualties = sum(as.numeric(number_of_casualties)))

# define the colour palette
cols <- rev(c("#ff7733", "#1de9b6","#006853"))
cust_theme <- theme(panel.grid.major = element_line(size = 2))
# put the elements in a list
dft_theme <- list(cust_theme, scale_color_manual(values = cols))

crash_time %>% 
  ggplot(aes(accident_hr, casualties, color = dow)) +
  geom_line(size = 2, alpha = .8) +
  dft_theme+
  theme(panel.background = element_blank()) +
  scale_x_continuous(expand = c(0, 0)) +
  ggtitle(paste0("Chart 4: Reported ", tolower(report_casualty), " KSIs by hour of day and day of week, GB: ", yr2calc-4, " to ", yr2calc)) +
  labs(x = "Hour starting", y = "casualties", caption = "Source: Stats19")

```

The weekday peak time for pedestrian KSIs is from 3pm to 6pm. By contrast, the peak is later in the early evening at weekends.


# 8. What type of road?
```{r, echo = FALSE, warning=FALSE, message=FALSE}

## create a table of severity by year
road_type <- crash_cas %>%
  select(accident_severity, casualty_type, datetime, first_road_class, urban_or_rural_area, number_of_casualties,accident_reference) %>%
  mutate(first_road_class = case_when(first_road_class == "A" ~ "Other",first_road_class == "B" ~ "Other",first_road_class == "C" ~ "Other",
                         first_road_class == "Unclassified" ~ "Other",first_road_class == "A(M)" ~ "Other",first_road_class == "Motorway" ~ "Motorway")) %>%
  filter(casualty_type == "Pedestrian") %>%
  mutate(count = 1) %>%
  group_by(first_road_class, urban_or_rural_area, accident_severity) %>%
  summarise(casualties = sum(count)) %>%
  filter(!urban_or_rural_area == "Unallocated")

m_way <- road_type %>%
  filter(first_road_class == "Motorway") %>%
  ungroup() %>%
  select(road_type = first_road_class, accident_severity, casualties)

rural_urban <- road_type %>%
  filter(first_road_class == "Other") %>%
  ungroup() %>%
  select(road_type = urban_or_rural_area, accident_severity, casualties)

road_types <- rbind(m_way, rural_urban) %>%
  group_by(accident_severity,road_type) %>%
  summarise(casualties = sum(casualties)) %>%
  mutate(pc = casualties/sum(casualties)*100)

all_cas_type <- rbind(m_way, rural_urban) %>%
  group_by(road_type) %>%
  summarise(casualties = sum(casualties)) %>%
  mutate(pc = casualties/sum(casualties)*100) %>%
  mutate(accident_severity = "All casualties")

road_type_bar <- rbind(road_types, all_cas_type) |> 
  filter(!road_type == "Data missing or out of range")

fatal_urban <- filter(road_type_bar, accident_severity == "Fatal" & road_type == "Urban")

all_cas <- filter(road_type_bar, accident_severity == "All casualties" & road_type == "Urban")

fatal_mway <- filter(road_type_bar, accident_severity == "Fatal" & road_type == "Motorway")

# define the colour palette
cols <- rev(c("#ff7733", "#1de9b6","#006853"))
cust_theme <- theme(panel.grid.major = element_line(size = 2))
dft_theme <- list(cust_theme, scale_fill_manual(values = cols))  # use fill, not co

# Grouped bar
ggplot(road_type_bar, aes(fill=road_type, y=pc, x=accident_severity, label = paste0(round(pc),"%"))) +
  geom_bar(position="dodge", stat="identity") +
  dft_theme +
  theme(
    panel.background = element_blank(),
    legend.position = "top",
    legend.title = element_blank()
  ) +
  theme(panel.background = element_blank()) +
  geom_text(position = position_dodge2(width = 0.9, preserve = "single"), angle = 0, vjust=-0.5, hjust=0.5) +
  xlab(NULL)+
  ylab(NULL)+
  ggtitle(paste0("Chart 5: Percentage of pedestrian casualties, by urban or rural classification and severity, GB: ", yr2calc-4, " to ", yr2calc)) +
  labs(caption = "Source: Stats19")

```
Chart 5 shows that between 2018 and 2022, `r round(fatal_urban$pc)`% of pedestrian fatalities occurred on urban roads compared to `r round(all_cas$pc)`% of all pedestrian casualties. `r round(fatal_mway$pc)`% of pedestrian fatalities occurred on motorways. This would be people outside their vehicles whether they are moving at the time or not.

# Vehicle movement on the road
```{r, echo = FALSE, warning=FALSE, message=FALSE}

## Discrepancy by what is meant with KSI?
## Junction table
junctions_pc <- junctions %>%
  mutate(pc = casualties/sum(casualties)*100) %>%
  dcast(junction_detail ~ accident_severity)

junctions_all <- crash_cas %>%
  mutate(wk = isoweek(date)) %>% ## calculate the day of week, Monday is 1
  select(wk, accident_severity, casualty_type, junction_detail, number_of_casualties,accident_reference) %>%
  filter(casualty_type == "Pedestrian") %>%
  mutate(count = 1) %>%
  group_by(junction_detail) %>%
  summarise(casualties = sum(count)) %>%
  mutate(all_casualties = casualties/sum(casualties)*100) %>%
  select(-casualties)

junction_table <- left_join(junctions_pc, junctions_all, by = "junction_detail") %>%
  mutate(Fatal = round(Fatal,1),
         Serious = round(Serious,1),
         Slight = round(Slight,1),
         all_casualties = round(all_casualties,1))

notatjunc <- filter(junction_table, junction_detail == "Not at junction or within 20 metres")

atjunc <- filter(junction_table, !junction_detail == "Not at junction or within 20 metres")

roundabouts <- filter(junction_table, junction_detail %in% c("Mini-roundabout", "Roundabout"))

junctions_all <- crash_cas %>%
  mutate(wk = isoweek(date)) %>% ## calculate the day of week, Monday is 1
  select(wk, accident_severity, casualty_type, junction_detail, number_of_casualties,accident_reference) %>%
  filter(casualty_type == "Pedestrian") %>%
  mutate(count = 1) %>%
  group_by(junction_detail) %>%
  summarise(casualties = round(sum(count),1)) %>%
  mutate(all_casualties = round(casualties/sum(casualties)*100),1) %>%
  select(-casualties)

kable(junction_table, caption = "Table 4: Percentage of pedestrian KSI casualties by severity and junction detail where the collision occurred, GB: 2018 to 2022")

```

A majority of pedestrian fatalities (`r round(notatjunc$Fatal)`%) do not occur at or within 20m of a junction compared to `r round(notatjunc$Serious)`% of serious injuries. However, `r round(sum(atjunc$Fatal))`% of fatalities occur at a junction compared to `r round(sum(atjunc$Fatal, na.rm = TRUE))`% of serious injuries. Pedestrian fatalities at roundabouts represent `r round(sum(roundabouts$Fatal))`% of all fatalities in contrast to `r round(sum(roundabouts$Serious))`% of serious injuries.

